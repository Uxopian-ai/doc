sequenceDiagram
    participant Client
    participant BFF as BFF / Gateway
    participant Service as uxopian-ai Service
    participant OS as OpenSearch
    participant LLM as External LLM

    Client->>+BFF: POST /api/v1/requests?conversation={id}
    Note right of Client: { inputs: [ { type: "goal", value: "compare", payload: {...} } ] }

    Note over BFF: Authenticate User
    BFF->>BFF: Inject Headers (X-User-TenantId, X-User-Id...)

    BFF->>+Service: Forward Request (with Auth Headers)
    
    Service->>Service: Identify message type (Goal > PromptId > Content)
    Note over Service: Goal detected in input. Resolving...

    Service->>+OS: Find Goal named "compare"
    OS-->>-Service: Return matching Goal definitions

    Service->>Service: Evaluate Goal filters vs. payload
    Note over Service: Filter matches => selects promptId: "detailedComparison"

    Service->>+OS: Get Prompt by ID "detailedComparison"
    OS-->>-Service: Return Prompt template

    Service->>+OS: Get recent conversation messages
    OS-->>-Service: Return context history

    Service->>Service: Render final prompt with Thymeleaf

    Service->>+LLM: Send rendered prompt
    LLM-->>-Service: Return LLM-generated response

    Service->>+OS: Persist user message and LLM response
    OS-->>-Service: Confirm storage

    Service-->>-BFF: Return response
    BFF-->>-Client: Forward response
